<th:block th:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (location.pathname !== '/auth' && !localStorage.getItem('token')) {
                location.href = '/auth';
                return;
            }
            const originalFetch = window.fetch;
            window.fetch = async (input, init = {}) => {
                init.headers = {
                    ...(init.headers || {}),
                    ...(localStorage.getItem('token') ? { 'Authorization': 'Bearer ' + localStorage.getItem('token') } : {})
                };
                return originalFetch(input, init);
            };
            document.querySelectorAll('form.api').forEach(form => {
                form.addEventListener('submit', async e => {
                    e.preventDefault();
                    const data = Object.fromEntries(new FormData(form).entries());
                    const res = await fetch(form.action, {
                        method: form.method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        if (form.id === 'sign-in-form' || form.id === 'sign-up-form') {
                            const info = await res.json();
                            localStorage.setItem('token', info.token);
                            location.href = '/';
                        } else {
                            location.reload();
                        }
                    } else if (res.status === 401) {
                        localStorage.removeItem('token');
                        location.href = '/auth';
                    }
                });
            });
            const btnLogout = document.getElementById('logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', async () => {
                    await fetch('/auth/logout', { method: 'POST' });
                    localStorage.removeItem('token');
                    location.href = '/auth';
                });
            }

            async function loadData() {
                const path = location.pathname;
                let url = null;
                let headers = {};
                let buildRow = () => '';

                if (path === '/crop') {
                    url = '/crop/all?page=0&size=20';
                    buildRow = c => `<tr><td>${c.id}</td><td>${c.alias}</td><td>${c.location}</td><td></td></tr>`;
                }

                const cropId = localStorage.getItem('cropId');
                if (['/irrigation', '/production', '/labor', '/nutrition', '/fumigation'].includes(path)) {
                    if (!cropId) return; // no crop selected
                    headers['cropId'] = cropId;
                    const base = path.replace('/', '');
                    url = `/${base}/all?page=0&size=20`;
                    if (path === '/irrigation') {
                        buildRow = i => `<tr><td>${i.id}</td><td>${i.date}</td><td>${i.type}</td><td></td></tr>`;
                    } else if (path === '/labor') {
                        buildRow = l => `<tr><td>${l.id}</td><td>${l.laborDate}</td><td>${l.kindLabor}</td><td></td></tr>`;
                    } else if (path === '/production') {
                        buildRow = p => `<tr><td>${p.id}</td><td>${p.productionDate}</td><td></td><td></td></tr>`;
                    } else if (path === '/nutrition' || path === '/fumigation') {
                        buildRow = n => `<tr><td>${n.id}</td><td>${n.applicationType}</td><td>${n.applicationDate}</td><td></td></tr>`;
                    }
                }

                if (!url) return;
                const res = await fetch(url, { headers });
                if (!res.ok) return;
                const data = await res.json();
                const items = data.content || [];
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';
                items.forEach(item => tbody.insertAdjacentHTML('beforeend', buildRow(item)));

                if (path === '/crop' && !cropId && items.length > 0) {
                    localStorage.setItem('cropId', items[0].id);
                }
            }

            loadData();
        });
    </script>
</th:block>

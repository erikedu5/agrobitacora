<th:block th:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (location.pathname !== '/auth' && !localStorage.getItem('token')) {
                location.href = '/auth';
                return;
            }
            const originalFetch = window.fetch;
            window.fetch = async (input, init = {}) => {
                init.headers = {
                    ...(init.headers || {}),
                    ...(localStorage.getItem('token') ? { 'Authorization': 'Bearer ' + localStorage.getItem('token') } : {})
                };
                return originalFetch(input, init);
            };
            function assign(obj, keys, value) {
                let current = obj;
                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    const prop = isNaN(Number(key)) ? key : Number(key);
                    const last = i === keys.length - 1;
                    if (last) {
                        current[prop] = value;
                    } else {
                        if (current[prop] === undefined) {
                            const nextIsNum = !isNaN(Number(keys[i + 1]));
                            current[prop] = nextIsNum ? [] : {};
                        }
                        current = current[prop];
                    }
                }
            }

            function formDataToObject(form) {
                const data = {};
                for (const [key, value] of new FormData(form).entries()) {
                    const parts = key.split(/\.|\[|\]/).filter(Boolean);
                    assign(data, parts, value);
                }
                return data;
            }

            function fillForm(form, data, prefix = '') {
                Object.entries(data).forEach(([k, v]) => {
                    const name = prefix ? `${prefix}.${k}` : k;
                    if (Array.isArray(v)) {
                        v.forEach((item, idx) => fillForm(form, item, `${name}[${idx}]`));
                    } else if (v && typeof v === 'object') {
                        fillForm(form, v, name);
                    } else {
                        const input = form.querySelector(`[name="${name}"]`);
                        if (input) input.value = v;
                    }
                });
            }

            document.querySelectorAll('form.api').forEach(form => {
                form.addEventListener('submit', async e => {
                    e.preventDefault();
                    const data = formDataToObject(form);
                    const method = form.dataset.method || form.getAttribute('method') || form.method;
                    const res = await fetch(form.action, {
                        method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        if (form.id === 'sign-in-form' || form.id === 'sign-up-form') {
                            const info = await res.json();
                            localStorage.setItem('token', info.token);
                            location.href = '/';
                        } else {
                            location.reload();
                        }
                    } else if (res.status === 401) {
                        localStorage.removeItem('token');
                        location.href = '/auth';
                    }
                });
            });
            const btnLogout = document.getElementById('logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', async () => {
                    await fetch('/auth/logout', { method: 'POST' });
                    localStorage.removeItem('token');
                    location.href = '/auth';
                });
            }

            async function loadData() {
                const path = location.pathname;
                let url = null;
                let headers = {};
                let buildRow = () => '';
                const enc = obj => encodeURIComponent(JSON.stringify(obj));

                if (path === '/crop') {
                    url = '/crop/all?page=0&size=20';
                    buildRow = c => `<tr data-item="${enc(c)}"><td>${c.id}</td><td>${c.alias}</td><td>${c.location}</td><td><button class='edit btn btn-sm btn-primary'>Editar</button> <button class='delete btn btn-sm btn-danger'>Eliminar</button></td></tr>`;
                }

                const cropId = localStorage.getItem('cropId');
                if (['/irrigation', '/production', '/labor', '/nutrition', '/fumigation'].includes(path)) {
                    if (!cropId) return; // no crop selected
                    headers['cropId'] = cropId;
                    const base = path.replace('/', '');
                    url = `/${base}/all?page=0&size=20`;
                    if (path === '/irrigation') {
                        buildRow = i => `<tr data-item="${enc(i)}"><td>${i.id}</td><td>${i.date}</td><td>${i.type}</td><td><button class='edit btn btn-sm btn-primary'>Editar</button> <button class='delete btn btn-sm btn-danger'>Eliminar</button></td></tr>`;
                    } else if (path === '/labor') {
                        buildRow = l => `<tr data-item="${enc(l)}"><td>${l.id}</td><td>${l.laborDate}</td><td>${l.kindLabor}</td><td><button class='edit btn btn-sm btn-primary'>Editar</button> <button class='delete btn btn-sm btn-danger'>Eliminar</button></td></tr>`;
                    } else if (path === '/production') {
                        buildRow = p => `<tr data-item="${enc(p)}"><td>${p.id}</td><td>${p.productionDate}</td><td></td><td><button class='edit btn btn-sm btn-primary'>Editar</button> <button class='delete btn btn-sm btn-danger'>Eliminar</button></td></tr>`;
                    } else if (path === '/nutrition' || path === '/fumigation') {
                        buildRow = n => `<tr data-item="${enc(n)}"><td>${n.id}</td><td>${n.applicationType}</td><td>${n.applicationDate}</td><td><button class='edit btn btn-sm btn-primary'>Editar</button> <button class='delete btn btn-sm btn-danger'>Eliminar</button></td></tr>`;
                    }
                }

                if (!url) return;
                const res = await fetch(url, { headers });
                if (!res.ok) return;
                const data = await res.json();
                const items = data.content || [];
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';
                items.forEach(item => tbody.insertAdjacentHTML('beforeend', buildRow(item)));
                tbody.querySelectorAll('button.delete').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const tr = btn.closest('tr');
                        const id = JSON.parse(decodeURIComponent(tr.dataset.item)).id;
                        const base = location.pathname.replace('/', '');
                        const res = await fetch(`/${base}/${id}`, { method: 'DELETE' });
                        if (res.ok) loadData();
                    });
                });
                tbody.querySelectorAll('button.edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tr = btn.closest('tr');
                        const data = JSON.parse(decodeURIComponent(tr.dataset.item));
                        const form = document.querySelector('form.api');
                        if (!form) return;
                        fillForm(form, data);
                        form.action = `${location.pathname}/${data.id}`;
                        form.dataset.method = 'PUT';
                    });
                });

                if (path === '/crop' && !cropId && items.length > 0) {
                    localStorage.setItem('cropId', items[0].id);
                }
            }

            loadData();
        });
    </script>
</th:block>
